<!doctype html>

<!--[if lt IE 7]><html lang="en-GB" xmlns:og="http://ogp.me/ns#" xmlns:fb="http://ogp.me/ns/fb#" class="no-js lt-ie9 lt-ie8 lt-ie7"><![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html lang="en-GB" xmlns:og="http://ogp.me/ns#" xmlns:fb="http://ogp.me/ns/fb#" class="no-js lt-ie9 lt-ie8"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html lang="en-GB" xmlns:og="http://ogp.me/ns#" xmlns:fb="http://ogp.me/ns/fb#" class="no-js lt-ie9"><![endif]-->
<!--[if gt IE 8]><!--> <html lang="en-GB" xmlns:og="http://ogp.me/ns#" xmlns:fb="http://ogp.me/ns/fb#" class="no-js"><!--<![endif]-->

	<head>
		<meta charset="utf-8">

				<meta http-equiv="X-UA-Compatible" content="IE=edge">

		<title>Inside the engine part 7 – Better relevance via dedup at query time - Milliseconds Matter</title>

				<meta name="HandheldFriendly" content="True">
		<meta name="MobileOptimized" content="320">
		<meta name="viewport" content="width=device-width, initial-scale=0.75, maximum-scale=0.75"/>

				<link rel="apple-touch-icon" href="https://blog.algolia.com/wp-content/themes/algolia/library/images/apple-touch-icon.png">
		<link rel="icon" href="https://blog.algolia.com/wp-content/themes/algolia/favicon.png">
		<!--[if IE]>
			<link rel="shortcut icon" href="https://blog.algolia.com/wp-content/themes/algolia/favicon.ico">
		<![endif]-->
				<meta name="msapplication-TileColor" content="#f01d4f">
		<meta name="msapplication-TileImage" content="https://blog.algolia.com/wp-content/themes/algolia/library/images/win8-tile-icon.png">
    <meta name="theme-color" content="#121212">

		<link rel="pingback" href="https://blog.algolia.com/xmlrpc.php">

        
<!-- This site is optimized with the Yoast SEO plugin v4.5 - https://yoast.com/wordpress/plugins/seo/ -->

<!-- / Yoast SEO plugin. -->

<link rel='dns-prefetch' href='//s0.wp.com' />
<link rel='dns-prefetch' href='//fonts.googleapis.com' />
<link rel='dns-prefetch' href='//s.w.org' />
<link rel="alternate" type="application/rss+xml" title="Milliseconds Matter &raquo; Feed" href="https://blog.algolia.com/feed/" />
<link rel="alternate" type="application/rss+xml" title="Milliseconds Matter &raquo; Comments Feed" href="https://blog.algolia.com/comments/feed/" />
<link rel="alternate" type="application/rss+xml" title="Milliseconds Matter &raquo; Inside the engine part 7 – Better relevance via dedup at query time Comments Feed" href="https://blog.algolia.com/inside-the-engine-part-7-better-relevance-via-dedup-at-query-time/feed/" />
		<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2.2.1\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2.2.1\/svg\/","svgExt":".svg","source":{"concatemoji":"https:\/\/blog.algolia.com\/wp-includes\/js\/wp-emoji-release.min.js"}};
			!function(a,b,c){function d(a){var b,c,d,e,f=String.fromCharCode;if(!k||!k.fillText)return!1;switch(k.clearRect(0,0,j.width,j.height),k.textBaseline="top",k.font="600 32px Arial",a){case"flag":return k.fillText(f(55356,56826,55356,56819),0,0),!(j.toDataURL().length<3e3)&&(k.clearRect(0,0,j.width,j.height),k.fillText(f(55356,57331,65039,8205,55356,57096),0,0),b=j.toDataURL(),k.clearRect(0,0,j.width,j.height),k.fillText(f(55356,57331,55356,57096),0,0),c=j.toDataURL(),b!==c);case"emoji4":return k.fillText(f(55357,56425,55356,57341,8205,55357,56507),0,0),d=j.toDataURL(),k.clearRect(0,0,j.width,j.height),k.fillText(f(55357,56425,55356,57341,55357,56507),0,0),e=j.toDataURL(),d!==e}return!1}function e(a){var c=b.createElement("script");c.src=a,c.defer=c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g,h,i,j=b.createElement("canvas"),k=j.getContext&&j.getContext("2d");for(i=Array("flag","emoji4"),c.supports={everything:!0,everythingExceptFlag:!0},h=0;h<i.length;h++)c.supports[i[h]]=d(i[h]),c.supports.everything=c.supports.everything&&c.supports[i[h]],"flag"!==i[h]&&(c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&c.supports[i[h]]);c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&!c.supports.flag,c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.everything||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
		<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
<link rel='stylesheet' id='wp-quicklatex-format-css'  href='https://blog.algolia.com/wp-content/plugins/wp-quicklatex/css/quicklatex-format.css' type='text/css' media='all' />
<link rel='stylesheet' id='jquery-ui-css'  href='https://blog.algolia.com/wp-content/plugins/algoliasearch-wordpress-master/lib/jquery/jquery-ui.min.css' type='text/css' media='all' />
<link rel='stylesheet' id='algolia_styles-css'  href='https://blog.algolia.com/wp-content/plugins/algoliasearch-wordpress-master/themes/algolia/styles.css' type='text/css' media='all' />
<link rel='stylesheet' id='cresta-social-crestafont-css'  href='https://blog.algolia.com/wp-content/plugins/cresta-social-share-counter/css/csscfont.css' type='text/css' media='all' />
<link rel='stylesheet' id='cresta-social-wp-style-css'  href='https://blog.algolia.com/wp-content/plugins/cresta-social-share-counter/css/cresta-wp-css.css' type='text/css' media='all' />
<link rel='stylesheet' id='cresta-social-googlefonts-css'  href='//fonts.googleapis.com/css?family=Noto+Sans:400,700' type='text/css' media='all' />
<link rel='stylesheet' id='googleFonts-css'  href='//fonts.googleapis.com/css?family=Raleway%3A400%2C600%2C700' type='text/css' media='all' />
<link rel='stylesheet' id='custom-algolia-scripts-css'  href='https://blog.algolia.com/wp-content/themes/algolia/style.css' type='text/css' media='all' />
<link rel='stylesheet' id='bones-stylesheet-css'  href='https://blog.algolia.com/wp-content/themes/algolia/library/css/style.css' type='text/css' media='all' />
<!--[if lt IE 9]>
<link rel='stylesheet' id='bones-ie-only-css'  href='https://blog.algolia.com/wp-content/themes/algolia/library/css/ie.css' type='text/css' media='all' />
<![endif]-->
<link rel='stylesheet' id='jetpack_css-css'  href='https://blog.algolia.com/wp-content/plugins/jetpack/css/jetpack.css' type='text/css' media='all' />
<script type='text/javascript' src='https://blog.algolia.com/wp-includes/js/jquery/jquery.js'></script>
<script type='text/javascript' src='https://blog.algolia.com/wp-includes/js/jquery/jquery-migrate.min.js'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var settings = [];
/* ]]> */
</script>
<script type='text/javascript' src='https://blog.algolia.com/wp-content/plugins/algoliasearch-wordpress-master/lib/jquery/jquery-ui.js'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var settings = [];
/* ]]> */
</script>
<script type='text/javascript' src='https://blog.algolia.com/wp-content/plugins/algoliasearch-wordpress-master/lib/algolia/algoliasearch.min.js'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var settings = [];
/* ]]> */
</script>
<script type='text/javascript' src='https://blog.algolia.com/wp-content/plugins/algoliasearch-wordpress-master/lib/hogan/hogan.js'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var settings = [];
/* ]]> */
</script>
<script type='text/javascript' src='https://blog.algolia.com/wp-content/plugins/algoliasearch-wordpress-master/lib/typeahead/typeahead.js'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var algoliaSettings = {"app_id":"latency","search_key":"6be0576ff61c053d5f9a3225e2a90f76","indices":[{"index_name":"wordpress_post","name":"Articles","order1":0,"order2":0}],"sorting_indices":[{"index_name":"wordpress_all_date_desc","label":""}],"index_name":"wordpress_","type_of_search":["instant"],"instant_jquery_selector":".algoliasearchcontainer","facets":[{"tax":"category","name":"","order":"19","type":"menu"}],"number_by_type":"3","number_by_page":"12","search_input_selector":"[name='s']","plugin_url":"https:\/\/blog.algolia.com\/wp-content\/plugins\/algoliasearch-wordpress-master\/","theme":{"dir":"algolia","name":"New Algolia","screenshot":"https:\/\/blog.algolia.com\/wp-content\/plugins\/algoliasearch-wordpress-master\/core\/..\/themes\/algolia\/screenshot.png","screenshot_autocomplete":"https:\/\/blog.algolia.com\/wp-content\/plugins\/algoliasearch-wordpress-master\/core\/..\/themes\/algolia\/screenshot.png","description":"","facet_types":{"menu":"Menu"}}};
var searchState = {"page":"1"};
/* ]]> */
</script>
<script type='text/javascript' src='https://blog.algolia.com/wp-content/plugins/algoliasearch-wordpress-master/front/main.js'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var themesSettings = [];
/* ]]> */
</script>
<script type='text/javascript' src='https://blog.algolia.com/wp-content/plugins/algoliasearch-wordpress-master/themes/algolia/theme.js'></script>
<script type='text/javascript' src='https://blog.algolia.com/wp-content/themes/algolia/library/js/libs/modernizr.custom.min.js'></script>
<script type='text/javascript' src='https://blog.algolia.com/wp-content/plugins/wp-quicklatex/js/wp-quicklatex-frontend.js'></script>
<link rel='https://api.w.org/' href='https://blog.algolia.com/wp-json/' />
<link rel='shortlink' href='https://blog.algolia.com/?p=5868' />
<link rel="alternate" type="application/json+oembed" href="https://blog.algolia.com/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fblog.algolia.com%2Finside-the-engine-part-7-better-relevance-via-dedup-at-query-time%2F" />
<link rel="alternate" type="text/xml+oembed" href="https://blog.algolia.com/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fblog.algolia.com%2Finside-the-engine-part-7-better-relevance-via-dedup-at-query-time%2F&#038;format=xml" />
<style type='text/css'>
			@media (max-width : 640px) {
				#crestashareicon {
					display:none !important;
				}
			}
		#crestashareicon {position:fixed; top:30%; right:20px; float:left;z-index:99;}

		#crestashareicon .sbutton {clear:both;display:none;}
		#crestashareicon .sbutton {float:right;}.cresta-share-icon.first_style .cresta-the-count {left: -11px;}#crestashareiconincontent {float: none; margin: 0 auto; display: table;}</style><script type="text/javascript">
(function(url){
	if(/(?:Chrome\/26\.0\.1410\.63 Safari\/537\.31|WordfenceTestMonBot)/.test(navigator.userAgent)){ return; }
	var addEvent = function(evt, handler) {
		if (window.addEventListener) {
			document.addEventListener(evt, handler, false);
		} else if (window.attachEvent) {
			document.attachEvent('on' + evt, handler);
		}
	};
	var removeEvent = function(evt, handler) {
		if (window.removeEventListener) {
			document.removeEventListener(evt, handler, false);
		} else if (window.detachEvent) {
			document.detachEvent('on' + evt, handler);
		}
	};
	var evts = 'contextmenu dblclick drag dragend dragenter dragleave dragover dragstart drop keydown keypress keyup mousedown mousemove mouseout mouseover mouseup mousewheel scroll'.split(' ');
	var logHuman = function() {
		var wfscr = document.createElement('script');
		wfscr.type = 'text/javascript';
		wfscr.async = true;
		wfscr.src = url + '&r=' + Math.random();
		(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(wfscr);
		for (var i = 0; i < evts.length; i++) {
			removeEvent(evts[i], logHuman);
		}
	};
	for (var i = 0; i < evts.length; i++) {
		addEvent(evts[i], logHuman);
	}
})('//blog.algolia.com/?wordfence_logHuman=1&hid=1677C715BEF795266FAA6A51D2653273');
</script>		<style>
		.gist table {
			margin-bottom: 0 !important;
			table-layout: auto !important;
		}
		.gist .line-numbers
		{
			width: 4em !important;
		}
		.gist .line,
		.gist .line-number
		{
			font-size: 12px !important;
			height: 18px !important;
			line-height: 18px !important;
		}
		.gist .line
		{
			white-space: pre !important;
			width: auto !important;
			word-wrap: normal !important;
		}
		.gist .line span
		{
			word-wrap: normal !important;
		}
		</style>
		<style type='text/css'>img#wpstats{display:none}</style><style type="text/css" id="custom-background-css">
body.custom-background { background-color: #ffffff; }
</style>

<!-- START - Facebook Open Graph, Google+ and Twitter Card Tags 2.0.8 -->
 <!-- Facebook Open Graph -->
  <meta property="og:locale" content="en_GB"/>
  <meta property="og:site_name" content="Milliseconds Matter"/>
  <meta property="og:title" content="Inside the engine part 7 – Better relevance via dedup at query time"/>
  <meta property="og:url" content="https://blog.algolia.com/inside-the-engine-part-7-better-relevance-via-dedup-at-query-time/"/>
  <meta property="og:type" content="article"/>
  <meta property="og:description" content="One of the most unique and most-used features of Algolia is the Distinct feature: it enables developers to deduplicate records on-the-fly at query time based on one specific attribute. We introduced this feature three years ago, opening up a broad range of new use cases like the deduplication of pro"/>
  <meta property="og:image" content="https://blog.algolia.com/wp-content/uploads/2017/01/blog-illus.png"/>
  <meta property="article:published_time" content="2017-01-16T04:38:46+00:00"/>
  <meta property="article:modified_time" content="2017-04-21T03:55:02+00:00" />
  <meta property="og:updated_time" content="2017-04-21T03:55:02+00:00" />
  <meta property="article:section" content="Guides"/>
  <meta property="article:section" content="Technology"/>
 <!-- Google+ / Schema.org -->
  <meta itemprop="name" content="Inside the engine part 7 – Better relevance via dedup at query time"/>
  <meta itemprop="description" content="One of the most unique and most-used features of Algolia is the Distinct feature: it enables developers to deduplicate records on-the-fly at query time based on one specific attribute. We introduced this feature three years ago, opening up a broad range of new use cases like the deduplication of pro"/>
  <meta itemprop="image" content="https://blog.algolia.com/wp-content/uploads/2017/01/blog-illus.png"/>
 <!-- Twitter Cards -->
  <meta name="twitter:title" content="Inside the engine part 7 – Better relevance via dedup at query time"/>
  <meta name="twitter:url" content="https://blog.algolia.com/inside-the-engine-part-7-better-relevance-via-dedup-at-query-time/"/>
  <meta name="twitter:description" content="One of the most unique and most-used features of Algolia is the Distinct feature: it enables developers to deduplicate records on-the-fly at query time based on one specific attribute. We introduced this feature three years ago, opening up a broad range of new use cases like the deduplication of pro"/>
  <meta name="twitter:image" content="https://blog.algolia.com/wp-content/uploads/2017/01/blog-illus.png"/>
  <meta name="twitter:card" content="summary_large_image"/>
  <meta name="twitter:site" content="@algolia"/>
 <!-- SEO -->
 <!-- Misc. tags -->
<!-- END - Facebook Open Graph, Google+ and Twitter Card Tags 2.0.8 -->

    
        <link rel="stylesheet" href="https://blog.algolia.com/wp-content/themes/algolia/library/css/icons.css">

	</head>

	<body class="post-template-default single single-post postid-5868 single-format-standard custom-background" itemscope itemtype="http://schema.org/WebPage">

    <!-- Google Tag Manager -->
    <noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-N8JP8G"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-N8JP8G');</script>
    <!-- End Google Tag Manager -->

		<div id="container">

			<header class="header" role="banner" itemscope itemtype="http://schema.org/WPHeader">

				<div id="inner-header" class="wrap cf">
          <ul id="links">
            <li><a href="https://www.algolia.com/jobs">Jobs</a></li>
            <li><a class="btn-primary" href="https://www.algolia.com/">Go to algolia.com</a></li>
          </ul>
          <a id="logo" href="/"><img src="https://www.algolia.com/static_assets/images/flat2/algolia/algolia-logo-45a5b66b.svg" width="130" alt="algolia"/></a>
										<p id="title" class="h1" itemscope itemtype="http://schema.org/Organization"><a href="https://blog.algolia.com" rel="nofollow">Milliseconds Matter</a></p>

										<p id="tagline">The Official Algolia Blog</p>


					<nav role="navigation" itemscope itemtype="http://schema.org/SiteNavigationElement">
						
					</nav>

				</div>

			</header>
			<div id="content">
				<div id="inner-content" class="wrap cf">

					<a class="single-back" href="#" onclick="goBack();">&lt;&nbsp;Back</a>

					<div id="search-input-wrapper" class="hide">
						<input id="search-input" placeholder="Search for posts, authors, ..." name="s" spellcheck="false"/>
					</div>

					<main id="main" class="d-all cf" role="main" itemscope itemprop="mainContentOfPage" itemtype="http://schema.org/Blog">

						<div class="algoliasearchcontainer hide"></div>
						<div class="post-content">
							
								
              
              <article id="post-5868" class="cf post-5868 post type-post status-publish format-standard has-post-thumbnail hentry category-guides category-technology" role="article" itemscope itemprop="blogPost" itemtype="http://schema.org/BlogPosting">

                <header class="article-header entry-header">

                  <h1 class="entry-title single-title" itemprop="headline" rel="bookmark">Inside the engine part 7 – Better relevance via dedup at query time</h1>

                  <p class="byline entry-meta vcard">
                    <img class="author-avatar" src="https://secure.gravatar.com/avatar/25760a5d4e793e491f26da5db64bb738?s=96&d=mm&r=g" onerror="this.onerror=null;this.src='https://blog.algolia.com/wp-content/themes/algolia/library/images/avatar-algolia.png'" />
                    <span class="entry-author author" itemprop="author" itemscope itemptype="http://schema.org/Person">julien</span> |
                    <time class="updated entry-time" datetime="2017-01-16" itemprop="datePublished">January 16, 2017</time> |
                    <span class="entry-categories"><a href="https://blog.algolia.com/category/guides/" rel="category tag">Guides</a>, <a href="https://blog.algolia.com/category/technology/" rel="category tag">Technology</a></span>
                  </p>

                                      <a href="https://blog.algolia.com/inside-the-engine-part-7-better-relevance-via-dedup-at-query-time/" title="Inside the engine part 7 – Better relevance via dedup at query time">
                    <img width="720" height="400" src="https://blog.algolia.com/wp-content/uploads/2017/01/blog-illus-720x400.png" class="attachment-algolia-post-720 size-algolia-post-720 wp-post-image" alt="" srcset="https://blog.algolia.com/wp-content/uploads/2017/01/blog-illus-720x400.png 720w, https://blog.algolia.com/wp-content/uploads/2017/01/blog-illus-320x178.png 320w, https://blog.algolia.com/wp-content/uploads/2017/01/blog-illus-768x428.png 768w, https://blog.algolia.com/wp-content/uploads/2017/01/blog-illus-718x400.png 718w, https://blog.algolia.com/wp-content/uploads/2017/01/blog-illus-340x189.png 340w" sizes="(max-width: 720px) 100vw, 720px" />                    </a>
                  
                </header> 
                <section class="entry-content cf" itemprop="articleBody">
                  <p class="lead">One of the most unique and most-used features of Algolia is the <a href="https://www.algolia.com/doc/guides/search/distinct/#doc-tab-content">Distinct feature</a>: it enables developers to deduplicate records on-the-fly at query time based on one specific attribute. We introduced this feature three years ago, opening up a broad range of new use cases like the <a href="https://www.algolia.com/doc/guides/search/distinct/#example-de-duplicating-variants-of-products">deduplication of product variants</a> &#8211; a must-have for any eCommerce search. It has also considerably changed the way we recommend handling big documents like PDFs or web pages (we recommend splitting each document into several records).</p>
<p>This post highlights the advantages of this feature and the different challenges it represents in term of implementation.</p>
<h2><a id="document-search-state-of-the-art-and-limitations" class="anchor" href="#document-search-state-of-the-art-and-limitations" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Document search: state of the art and limitations</h2>
<p>Searching inside large documents is probably the oldest challenge of information retrieval. It was inspired from the index at the end of books and gave the birth to an entire sub-genre of statistics. Among those methods, <a href="https://en.wikipedia.org/wiki/Tf%E2%80%93idf">tf-idf</a> and <a href="https://en.wikipedia.org/wiki/Okapi_BM25">BM25</a> are the two most popular. They are very effective for ranking documents, but they don&#8217;t handle false positives well &#8211; they push them to the bottom of the results.</p>
<p>To illustrate this problem, you can perform the &#8220;states programming&#8221; query on Google and Wikipedia. According to <a href="https://www.google.com/trends/explore?q=states%20programming,rust%20programming%20language">Google Trends</a>, this query is as popular as the Rust programming language and seems to correspond to developers that search how to develop an algorithm with a state. The same query on Wikipedia is unfortunately not very relevant! The first issue probably comes from a stemming algorithm or a synonym that considers &#8220;program&#8221; as the same than &#8220;programming.&#8221; In Algolia, you can have an expansion of singular/plural without polluting results with stemming by using the <a href="https://www.algolia.com/doc/api-client/javascript/parameters/#ignoreplurals">ignorePlurals feature</a>, which is based on a linguistic lemmatizer.</p>
<p>That said, even if you scroll through the first 1000 hits of Wikipedia search, you won&#8217;t find the article which appears first in Google. There are hundreds of articles that contain both the word &#8220;states&#8221; and &#8220;programming.&#8221; Even the &#8220;United States&#8221; page contains both terms and one is in the title! In this case, tf-idf and BM25 are not the most useful ranking criteria. The position of the two query terms in the document is more important, in addition to their relative distance (finding them close together is always better).</p>
<div id="attachment_5869" style="width: 3176px" class="wp-caption aligncenter"><a href="https://blog.algolia.com/inside-the-engine-part-7-better-relevance-via-dedup-at-query-time/statesprogrammingquery/" rel="attachment wp-att-5869"><img class="size-full wp-image-5869" src="https://blog.algolia.com/wp-content/uploads/2017/01/StatesProgrammingQuery.png" alt="States programming query on Google and Wikipedia" width="3166" height="1449" srcset="https://blog.algolia.com/wp-content/uploads/2017/01/StatesProgrammingQuery.png 3166w, https://blog.algolia.com/wp-content/uploads/2017/01/StatesProgrammingQuery-320x146.png 320w, https://blog.algolia.com/wp-content/uploads/2017/01/StatesProgrammingQuery-768x351.png 768w, https://blog.algolia.com/wp-content/uploads/2017/01/StatesProgrammingQuery-720x330.png 720w" sizes="(max-width: 3166px) 100vw, 3166px" /></a><p class="wp-caption-text">States programming query on Google and Wikipedia</p></div>
<h2><a id="why-do-we-split-large-documents" class="anchor" href="#why-do-we-split-large-documents" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Why do we split large documents</h2>
<p>One of the best ways to avoid such relevance problems is to split big pages into several records &#8211; for example, you could create one record per section of the Wikipedia page. If a Wikipedia article were to have 4 main sections, we could create 4 different records, with the same article title, but different body content.</p>
<p>For example, instead of the following big record with the four sections embedded:</p>
<div class="oembed-gist"><script src="https://gist.github.com/speedblue/9a823e0a38949895bd5f58d1caa156c3.js"></script><noscript>View the code on <a href="https://gist.github.com/speedblue/9a823e0a38949895bd5f58d1caa156c3">Gist</a>.</noscript></div>
<p>We could have 5 different records, one for the main one and one per section. All those records will share the same source attribute that we will use to indicate the engine that they are all component of the same article:</p>
<div class="oembed-gist"><script src="https://gist.github.com/speedblue/a38380a3573136a70f3863e71dc38282.js"></script><noscript>View the code on <a href="https://gist.github.com/speedblue/a38380a3573136a70f3863e71dc38282">Gist</a>.</noscript></div>
<p>We can use this same approach for technical documentation, as there are often just a few long pages in order to improve the developer experience: scrolling is better than loading new pages! This is exactly why we have decided to split pages into several records in our <a href="https://community.algolia.com/docsearch/">DocSearch</a> project; you can learn more about our approach in this <a href="https://blog.algolia.com/how-to-build-a-helpful-search-for-technical-documentation-the-laravel-example/">blog post</a>.</p>
<p>It might sound counter-intuitive, but the problem is even more visible when your data set is smaller! While the problem is only visible on well-selected queries on the Wikipedia use case, it becomes very apparent when you search inside a website with less content. You have a high probability of having false positives in your search that will frustrate for your users.</p>
<h2><a id="the-need-for-deduplication" class="anchor" href="#the-need-for-deduplication" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>The need for deduplication</h2>
<p>Splitting a page into several records is usually easy as you can use the formatting as a way to split. The problem with several records per document is that you will introduce duplicates in your search results. For example, all paragraphs of the United States Wikipedia article will match for the &#8220;United States&#8221; query. In this case, you would like to keep only the best match and avoid duplicates in the search results.</p>
<p>This is where the distinct feature comes to play! You just have to introduce one attribute with the same value for all records of the same source (typically an ID of the document) and declare it as the <a href="https://www.algolia.com/doc/api-client/javascript/parameters/#attributefordistinct"><i>attributeForDistinct</i></a> in your index setting. At query time, only the best match for each value of the attribute for distinct will be kept, all the other records will be removed to avoid any duplicate.</p>
<p>If we split the United States Wikipedia article by section and subsections, it would generate 39 records. You can find the first four records on this gist:</p>
<div class="oembed-gist"><script src="https://gist.github.com/speedblue/c09f84362d8122e2b03af8fac1dfbd8c.js"></script><noscript>View the code on <a href="https://gist.github.com/speedblue/c09f84362d8122e2b03af8fac1dfbd8c">Gist</a>.</noscript></div>
<p>This split by section reduces a lot the probability of noise on large articles. It avoids the query &#8220;Etymology Indigenous&#8221; to match this article (which would typically match because there is a section called &#8220;Etymology&#8221; and another one called &#8220;Indigenous and European contact&#8221;). To improve the relevance, we have also divided the records into three different types that we order from the most important to the less important via the <i>recordTypeScore</i> attribute:</p>
<ul>
<li>&#8220;main&#8221;, this is the first section of the article, including the title and synonyms (score of 3)</li>
<li>&#8220;section&#8221;: those are the main sections of the article (score of 2)</li>
<li>&#8220;subsection&#8221;: subdivision inside the sections of the article (score of 1)</li>
</ul>
<p>The <i>recordTypeScore </i>attribute will be used in the ranking to give more importance to the &#8220;main&#8221; records than the &#8220;section&#8221; and &#8220;subsection&#8221;.</p>
<p>Another good property of this split is that it allows linking to the right section of the page when you click on the search result. For example, if you search for &#8220;united states Settlements&#8221;, you will be able to open the United States page with the anchor text stored in the record.</p>
<p>Here is the list of the four Algolia settings we applied on this index:</p>
<div class="oembed-gist"><script src="https://gist.github.com/speedblue/4c90834a5d441ff7eb5d9260c4f057c7.js"></script><noscript>View the code on <a href="https://gist.github.com/speedblue/4c90834a5d441ff7eb5d9260c4f057c7">Gist</a>.</noscript></div>
<p>You can set those settings via the <a href="https://www.algolia.com/doc/api-client/ruby/settings/#set-settings">setSettings API call</a> or directly on the dashboard:</p>
<ul>
<li><i>searchableAttributes</i> and <i>customRanking</i> can be configured in the <i>Ranking</i> tab</li>
</ul>
<div id="attachment_5870" style="width: 1934px" class="wp-caption aligncenter"><a href="https://blog.algolia.com/inside-the-engine-part-7-better-relevance-via-dedup-at-query-time/insideengine7searchableattributesandcustomranking/" rel="attachment wp-att-5870"><img class="size-full wp-image-5870" src="https://blog.algolia.com/wp-content/uploads/2017/01/InsideEngine7searchableAttributesAndCustomRanking.png" alt="Algolia Dashboard: Searchable &amp; Ranking Attributes" width="1924" height="1054" srcset="https://blog.algolia.com/wp-content/uploads/2017/01/InsideEngine7searchableAttributesAndCustomRanking.png 1924w, https://blog.algolia.com/wp-content/uploads/2017/01/InsideEngine7searchableAttributesAndCustomRanking-320x175.png 320w, https://blog.algolia.com/wp-content/uploads/2017/01/InsideEngine7searchableAttributesAndCustomRanking-768x421.png 768w, https://blog.algolia.com/wp-content/uploads/2017/01/InsideEngine7searchableAttributesAndCustomRanking-720x394.png 720w" sizes="(max-width: 1924px) 100vw, 1924px" /></a><p class="wp-caption-text">Algolia Dashboard: Searchable &amp; Ranking Attributes</p></div>
<ul>
<li>ignorePlurals can also be configured in the <i>Ranking</i> tab. For the moment you can only enable it for all languages in the dashboard (setting it to true), we will improve this setting to let you configure also the language.</li>
<li>attributesForDistinct can be configured in the <i>Display</i> tab of the dashboard:</li>
</ul>
<div id="attachment_5871" style="width: 1934px" class="wp-caption aligncenter"><a href="https://blog.algolia.com/inside-the-engine-part-7-better-relevance-via-dedup-at-query-time/insideengine7distinct/" rel="attachment wp-att-5871"><img class="size-full wp-image-5871" src="https://blog.algolia.com/wp-content/uploads/2017/01/InsideEngine7Distinct.png" alt="Algolia Dashboard: Group by" width="1924" height="612" srcset="https://blog.algolia.com/wp-content/uploads/2017/01/InsideEngine7Distinct.png 1924w, https://blog.algolia.com/wp-content/uploads/2017/01/InsideEngine7Distinct-320x102.png 320w, https://blog.algolia.com/wp-content/uploads/2017/01/InsideEngine7Distinct-768x244.png 768w, https://blog.algolia.com/wp-content/uploads/2017/01/InsideEngine7Distinct-720x229.png 720w" sizes="(max-width: 1924px) 100vw, 1924px" /></a><p class="wp-caption-text">Algolia Dashboard: Group by</p></div>
<p>Each of those settings is important for the relevance:</p>
<ul>
<li>The <i>customRanking</i> uses the <i>recordTypeScore </i>to give importance to the main chapter in the case of equality on the textual relevance. In case of equality, we use the <i>popularity</i> attribute which represents the number of backlinks inside Wikipedia to this article (all records of the article keep the same popularity)</li>
<li>The order of attributes in <em>searchableAttributes</em> gives the following decreasing importance for the matching attributes, title &gt; text &gt; synonyms &gt; sourceArticle</li>
<li>The <em>attributeForDistinct</em> is applied on the name of the article, only the best elements will be displayed for each matched articles</li>
<li>We set <em>ignorePlurals</em> to &#8220;en&#8221; to consider all singular/plurals form of English as identical without introducing any noise (you can also set this setting at query time if you have a search in a different language using the same index)</li>
</ul>
<p>With those settings, you can easily request a set of results without duplicates with the query parameter <i>distinct=true</i>. You can go even further by requesting several hits per deduplication key. You can, for example, pass <a href="https://www.algolia.com/doc/guides/search/distinct/#distinct-for-grouping">distinct=3 in your query</a> to retrieve up to three results per distinct key &#8211; this feature is usually known as grouping.</p>
<h2><a id="keeping-several-records-per-distinct-key" class="anchor" href="#keeping-several-records-per-distinct-key" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Keeping several records per distinct key</h2>
<p>Search engines are also used for navigation or criteria-based search due to the fact that those queries are cheaper than on a regular database. Keeping several records per distinct key makes it easy to bring a different display to search.</p>
<p>For example, if you want to build a list of job offers, you will probably let the user search via different criteria like the role, location, job type, etc &#8211; but you might also want to aggregate the search results per company instead of having each job display company information. This is what <a href="https://angel.co/jobs">AngelList</a> is doing when you search for a job on their platform. They display companies along with the three best job offers, this type of display can be built very quickly by:</p>
<ul>
<li>Having one record per job offer with an attribute containing the company ID</li>
<li>Configuring the company ID attribute as <i>attributeForDistinct</i> in the index settings</li>
<li>Passing <i>distinct=3</i> in your query</li>
</ul>
<p>With those three simple actions, you can build an interface like AngelList below (Note that <i>SafeGraph</i> has only two job offers that match the criteria, the value three is the upper-bound limit on the number of records we want per distinct key). Some customers also implement a <i>&#8220;Show more&#8221;</i> button on each company that allows to display all offers for this company. To implement it, you have just to filter on the company name and specify <i>distinct=false</i> on the query to retrieve all offers of this company.</p>
<div id="attachment_5881" style="width: 1068px" class="wp-caption aligncenter"><a href="https://blog.algolia.com/inside-the-engine-part-7-better-relevance-via-dedup-at-query-time/screen-shot-2017-01-16-at-09-58-40-2/" rel="attachment wp-att-5881"><img class="size-full wp-image-5881" src="https://blog.algolia.com/wp-content/uploads/2017/01/Screen-Shot-2017-01-16-at-09.58.40-1.png" alt="AngelList job search displaying several jobs per company" width="1058" height="874" srcset="https://blog.algolia.com/wp-content/uploads/2017/01/Screen-Shot-2017-01-16-at-09.58.40-1.png 1058w, https://blog.algolia.com/wp-content/uploads/2017/01/Screen-Shot-2017-01-16-at-09.58.40-1-215x178.png 215w, https://blog.algolia.com/wp-content/uploads/2017/01/Screen-Shot-2017-01-16-at-09.58.40-1-768x634.png 768w, https://blog.algolia.com/wp-content/uploads/2017/01/Screen-Shot-2017-01-16-at-09.58.40-1-484x400.png 484w" sizes="(max-width: 1058px) 100vw, 1058px" /></a><p class="wp-caption-text">AngelList job search displaying several jobs per company</p></div>
<h2><a id="the-impact-of-distinct-on-faceting" class="anchor" href="#the-impact-of-distinct-on-faceting" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>The Impact of Distinct on faceting</h2>
<p>Faceting can very quickly become a headache when distinct is enabled. Let&#8217;s illustrate the problem with a very simple example containing two records sharing the same distinct key.</p>
<div class="oembed-gist"><script src="https://gist.github.com/speedblue/b370d1e9c4154b584d7caac0923f882b.js"></script><noscript>View the code on <a href="https://gist.github.com/speedblue/b370d1e9c4154b584d7caac0923f882b">Gist</a>.</noscript></div>
<p>The first record contains the facet values &#8220;A&#8221; and &#8220;B&#8221; and the second record contains the facet values &#8220;B&#8221; and &#8220;C&#8221;.</p>
<p>Let&#8217;s imagine that you have a query that retrieves both records and that faceting and distinct is enabled in your query. You can imagine three different behaviors in this case:</p>
<ul>
<li><b>Computing the faceting before the deduplication</b> (using distinct). In that case, the possible facet values will be &#8220;A=1&#8221;, &#8220;B=2&#8221; and &#8220;C=1&#8221;. All categories are retrieved but the count won&#8217;t fit what you have on screen.</li>
<li><b>Computing the faceting after deduplication</b> (distinct). In this case, the result would be &#8220;A=1&#8221;, &#8220;B=1&#8221; OR &#8220;B=1&#8221;, &#8220;C=1&#8221; depending on the best matching record. In both cases, the result is not what you expect.</li>
<li><b>Applying deduplication independently for each facet value</b>. In this case, we would have A=1, B=1 and C=1 (for each facet value, we need to look at all distinct key and perform a deduplication at this level).</li>
</ul>
<p>The third behavior is the holy grail as the result of each facet count would be perfect. Unfortunately, the computation cost is insane and doesn&#8217;t scale as it directly depends on the number of facet values which match. In practice, it&#8217;s impossible to compute it in real time.</p>
<p>Let&#8217;s look at the advantages and drawbacks of the two approaches which can be computed for each query in a reasonable time:</p>
<ul>
<li><b>Computing the faceting before the deduplication</b>: all retrieved facets are valid but the problem is obviously the counts are misleading because they include the duplicates. That said, this approach works very well if you do not want to display the count, it handle any case including the fact you can have different facets in the records that share the same distinct key.</li>
<li><b>Computing the faceting after the deduplication</b>: this approach works well when you use distinct=1 and all records with the same distinct key share the same facet values, which correspond exactly to the use case of splitting big documents. In other use cases, the results will be disturbing for users as some facet values can appear/disappear depending on the record which is kept after deduplication.</li>
</ul>
<p>In other words, there is no perfect solution solving all problems. This is why we have decided to implement both approaches but as the deduplication can be misleading and cause weird effect, we have decided to use the faceting before the deduplication as the standard behavior. We have a query parameter called <a href="https://www.algolia.com/doc/rest-api/search/#facetingafterdistinct">facetingAfterDistinct=true</a> that can be added to your query when you are splitting some big records. In this case, you have a perfect result because the facets are identical in all records sharing the same distinct key.</p>
<h2><a id="great-features-take-time" class="anchor" href="#great-features-take-time" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Great features take time</h2>
<p>We introduced the distinct feature in December 2013 and have improved it significantly in July 2015 by adding the support of distinct=N in the engine. The different faceting strategies have been a long-standing challenge and it took us a lot of time to find the best approach. The query parameter <i>facetingAfterDistinct=true </i>has been beta tested with real users for a few months before becoming public in December 2016.</p>
<p>This feature opened a lot of possibilities for our users and allowed a better indexing of big records that later gave the birth to our <a href="https://community.algolia.com/docsearch/">DocSearch</a> project.</p>
<p>If you want to know more about the internal of the Algolia engine, we recommend to read the other posts in this series:</p>
<ul>
<li><a href="https://blog.algolia.com/inside-the-algolia-engine-part-1-indexing-vs-search/">Part 1—indexing vs. search</a></li>
<li><a href="https://blog.algolia.com/inside-the-algolia-engine-part-2-the-indexing-challenge-of-instant-search/">Part 2—the indexing challenge of instant search</a></li>
<li><a href="https://blog.algolia.com/inside-the-algolia-engine-part-3-query-processing/">Part 3—query processing</a></li>
<li><a href="https://blog.algolia.com/inside-the-algolia-enginepart-4-textual-relevance/">Part 4—textual relevance</a></li>
<li><a href="https://blog.algolia.com/inside-the-algolia-engine-part-5-highlighting-a-cornerstone-to-search-ux/">Part 5—Highlighting, a Cornerstone of Search UX</a></li>
<li><a href="https://blog.algolia.com/inside-the-engine-part-6-handling-synonyms-the-right-way/">Part 6—Handling Synonyms the Right Way</a></li>
</ul>
<!--www.crestaproject.com Social Button in Content Start--><div id="crestashareiconincontent" class="cresta-share-icon first_style"><div class="sbutton  facebook-cresta-share" id="facebook-cresta-c"><a rel="nofollow" href="https://www.facebook.com/sharer.php?u=https%3A%2F%2Fblog.algolia.com%2Finside-the-engine-part-7-better-relevance-via-dedup-at-query-time%2F&amp;t=Inside+the+engine+part+7+%E2%80%93+Better+relevance+via+dedup+at+query+time" title="Share to Facebook" onclick="window.open(this.href,'targetWindow','toolbars=0,location=0,status=0,menubar=0,scrollbars=1,resizable=1,width=640,height=320,left=200,top=200');return false;"><i class="cs c-icon-cresta-facebook"></i></a></div><div class="sbutton  twitter-cresta-share" id="twitter-cresta-c"><a rel="nofollow" href="https://twitter.com/share?text=Inside+the+engine+part+7+%E2%80%93+Better+relevance+via+dedup+at+query+time&amp;url=https%3A%2F%2Fblog.algolia.com%2Finside-the-engine-part-7-better-relevance-via-dedup-at-query-time%2F&amp;via=algolia" title="Share to Twitter" onclick="window.open(this.href,'targetWindow','toolbars=0,location=0,status=0,menubar=0,scrollbars=1,resizable=1,width=640,height=320,left=200,top=200');return false;"><i class="cs c-icon-cresta-twitter"></i></a></div><div class="sbutton  linkedin-cresta-share" id="linkedin-cresta-c"><a rel="nofollow" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3A%2F%2Fblog.algolia.com%2Finside-the-engine-part-7-better-relevance-via-dedup-at-query-time%2F&amp;title=Inside+the+engine+part+7+%E2%80%93+Better+relevance+via+dedup+at+query+time&amp;source=https://blog.algolia.com/" title="Share to LinkedIn" onclick="window.open(this.href,'targetWindow','toolbars=0,location=0,status=0,menubar=0,scrollbars=1,resizable=1,width=640,height=320,left=200,top=200');return false;"><i class="cs c-icon-cresta-linkedin"></i></a></div><div style="clear: both;"></div></div><div style="clear: both;"></div><!--www.crestaproject.com Social Button in Content End-->                </section> 
                <!-- <footer class="article-footer">


                </footer>-->
                
                
<div id="disqus_thread">
            <div id="dsq-content">


            <ul id="dsq-comments">
                    <li class="comment even thread-even depth-1" id="dsq-comment-554">
        <div id="dsq-comment-header-554" class="dsq-comment-header">
            <cite id="dsq-cite-554">
                <span id="dsq-author-user-554">Olivier@Exa</span>
            </cite>
        </div>
        <div id="dsq-comment-body-554" class="dsq-comment-body">
            <div id="dsq-comment-message-554" class="dsq-comment-message"><p>Great topic 🙂<br />
I came across this great facetting implementation, on a bathroom equipment e-merchant :<br />
<a href="https://www.reuter-shop.com/bathroom/shower-trays.html/" rel="nofollow">https://www.reuter-shop.com/bathroom/shower-trays.html/</a><br />
Each item has options, sometimes thousands. What is great is that each of them is individually findable, with the grouping feature being merely to avoid visual clutter :<br />
<a href="https://www.reuter-shop.com/bathroom/shower-trays.html/filter/width/102,180" rel="nofollow">https://www.reuter-shop.com/bathroom/shower-trays.html/filter/width/102,180</a><br />
(notice  how the options count decrease).<br />
This is a case when you&#8217;d want to do facetting before grouping AND display facet counts.<br />
O@Exa</p>
</div>
        </div>

    </li><!-- #comment-## -->
            </ul>


        </div>

    </div>

                                                  
              </article> 
							
													</div>

						<section id="subscribe-newsletter" class="cf">
    <div id="mc4wp-form-1" class="form mc4wp-form">
        <form action="https://go.pardot.com/l/139121/2016-06-09/f3kzm" method="post" role="form" lpformnum="1">
            <p>
                <input type="email" id="mc4wp_email" name="email" placeholder="Your email address" required="">
            </p>
            <p>
                <input type="submit" value="Sign up">
            </p>
        </form>
    </div>
</section>

					</main>

					
				</div>

			</div>

			<footer class="footer" role="contentinfo" itemscope itemtype="http://schema.org/WPFooter">

				<div id="inner-footer" class="wrap cf">

          <a class="footer-logo" href="https://www.algolia.com">
            <img src="https://www.algolia.com/static_assets/images/flat2/algolia/algolia-logo-45a5b66b.svg" width="150" alt="algolia"/>
          </a>

          <p class="footer-tagline">We make instant and relevant search.<br>
          Easy for developers, delightful for the users.
          <p>

          <ul class="social-links">
            <li><a class="social-twitter" href="https://twitter.com/algolia"><i class="icon-twitter"></i></a></li>
            <li><a class="social-googleplus" href="https://plus.google.com/+Algolia"><i class="icon-google-plus"></i></a></li>
            <li><a class="social-facebook" href="https://www.facebook.com/algolia"><i class="icon-facebook2"></i></a></li>
            <li><a class="social-linkedin" href="https://www.linkedin.com/company/algolia"><i class="icon-linkedin2"></i></a></li>
            <li><a class="social-github" href="https://github.com/Algolia"><i class="icon-github2"></i></a></li>
          </ul>

					<p class="source-org copyright">&copy;Algolia - <a href="https://www.algolia.com/policies/privacy">Privacy Policy</a></p>

				</div>

			</footer>

		</div>

				<script type="text/template" id="autocomplete-template">
    <div class="result">
        <div class="title">
            {{#featureImage}}
            <img style="width: 30px" src="{{{ featureImage.sizes.thumbnail.file }}}" />
            {{/featureImage}}
            {{{ _highlightResult.title.value }}}
        </div>
    </div>
</script>

<script type="text/template" id="instant-content-template">
    <div class="search-sorting">
        <span class="label">Sort by</span>
        <select id="index_to_use">
            <option {{#sortSelected}}{{relevance_index_name}}{{/sortSelected}} value="{{relevance_index_name}}">Relevance</option>
            {{#sorting_indices}}
            <option {{#sortSelected}}{{index_name}}{{/sortSelected}} value="{{index_name}}">{{label}}</option>
            {{/sorting_indices}}
        </select>
    </div>
    <div class="cf spacer20"></div>
    <div class="hits-wrapper">
      {{#hits}}
          {{^query}}
              <div class="d-1of3 t-1of2" algolia-object-id="{{ objectID }}">
                  <article class="grid-entry grid-entry--columns">
                      <header class="article-header">
                          <a href="{{permalink}}"><img class="entry-illus" src="{{featureImage.sizes.medium.file}}"/></a>
                          <h1 class="h3 entry-title"><a href="{{permalink}}">{{{ _highlightResult.title.value }}}</a></h1>
                      </header>
                  </article>
              </div>
          {{/query}}

          {{#query}}
            <article class="grid-entry grid-entry--detailled" algolia-object-id="{{ objectID }}">
                <div class="d-1of3 t-1of3">
                    <a href="{{permalink}}"><img class="entry-illus" src="{{featureImage.sizes.medium.file}}"/></a>
                </div>
                <div class="d-2of3 t-2of3">
                    <h1 class="h3 entry-title"><a href="{{permalink}}">{{{ _highlightResult.title.value }}}</a></h1>

                    <span class="entry-author" data-tax="author" data-name="{{ author }}" >
                        <img class="author-avatar" src="{{ avatar_url }}" onerror="this.onerror=null;this.style.border='1px solid rgb(0, 164, 255)';this.src='/wp-content/themes/algolia/library/images/avatar-algolia.png'"/>
                        {{{ _highlightResult.author.value }}}
                    </span>
                    <span class="entry-date">{{#getDate}}{{date}}{{/getDate}}</span>
                    <p class="entry-desc">...{{{ _snippetResult.content.value }}}...</p>

                    <ul class="tags">
                    {{#_highlightResult.post_tag}}
                        <li class="match-{{matchLevel}}">{{{value}}}</li>
                    {{/_highlightResult.post_tag}}
                    </ul>
                </div>
                <div class="cf"></div>
            </article>
          {{/query}}

      {{/hits}}
    </div>
    {{^hits.length}}
    <div class="no-result">
      <div>No posts nor authors matched your query <strong>{{ query }}</strong>.</div>
      <div><a href="#" class="clear-button">clear search</a></div>
    </div>
    {{/hits.length}}
</script>


<script type="text/template" id="instant-facets-template">
    {{#facets}}
    {{#count}}
    <div class="search-filters {{tax}}">
        {{#facet_categorie_name}}
            <span class="label">
                {{ facet_categorie_name }}
            </span>
        {{/facet_categorie_name}}
        <ul>
            {{#sub_facets}}

                {{#type.conjunctive}}
                <li class="{{#checked}} checked {{/checked}} sub_facet conjunctive related-tag {{#hidden}} hide {{/hidden}}">
                    <input style="display: none;" data-tax="{{tax}}" {{#checked}} checked {{/checked}} data-name="{{name}}" class="facet_value" type="checkbox" />
                    {{name}}
                </li>
                {{/type.conjunctive}}

                {{#type.disjunctive}}
                <li class="{{#checked}} checked {{/checked}} sub_facet disjunctive">
                    <input style="display: none;" data-tax="{{tax}}" {{#checked}} checked {{/checked}} data-name="{{name}}" class="facet_value" type="checkbox" />
                    {{name}} {{#count}}({{count}}){{/count}}
                </li>
                {{/type.disjunctive}}

                {{#type.menu}}
                <li data-tax="{{tax}}" data-name="{{nameattr}}" data-type="menu" class="{{#checked}}checked {{/checked}}sub_facet disjunctive menu {{#category}}category{{/category}}">
                    <input style="display: none;" data-tax="{{tax}}" {{#checked}}checked{{/checked}} data-name="{{nameattr}}" class="facet_value" type="checkbox" />
                    {{name}} {{#print_count}}{{#count}}<span class="facet-count">{{count}}</span>{{/count}}{{/print_count}}
                </li>
                {{/type.menu}}

            {{/sub_facets}}
        </ul>
    </div>
    {{/count}}
    {{/facets}}
</script>



<script type="text/template" id="instant-pagination-template">
    <div class="pagination-wrapper cf">
        <ul class="pagination">
            <li {{^prev_page}}class="disabled"{{/prev_page}}>
                <a href="#" data-page="{{prev_page}}">
                    Previous
                </a>
            </li>

            {{#pages}}
            <li class="{{#current}}active{{/current}}{{#disabled}}disabled{{/disabled}}">
                <a href="#" data-page="{{number}}">
                    {{ number }}
                </a>
            </li>
            {{/pages}}

            <li {{^next_page}}class="disabled"{{/next_page}}>
                <a href="#" data-page="{{next_page}}">
                    Next
                </a>
            </li>
        </ul>
    </div>
</script>
<!--www.crestaproject.com Social Button Floating Start--><div id="crestashareicon" class="cresta-share-icon  first_style "><div class="sbutton  facebook-cresta-share float" id="facebook-cresta"><a rel="nofollow" href="https://www.facebook.com/sharer.php?u=https%3A%2F%2Fblog.algolia.com%2Finside-the-engine-part-7-better-relevance-via-dedup-at-query-time%2F&amp;t=Inside+the+engine+part+7+%E2%80%93+Better+relevance+via+dedup+at+query+time" title="Share to Facebook" onclick="window.open(this.href,'targetWindow','toolbars=0,location=0,status=0,menubar=0,scrollbars=1,resizable=1,width=640,height=320,left=200,top=200');return false;"><i class="cs c-icon-cresta-facebook"></i></a></div><div class="sbutton  twitter-cresta-share float noCount" id="twitter-cresta"><a rel="nofollow" href="https://twitter.com/share?text=Inside+the+engine+part+7+%E2%80%93+Better+relevance+via+dedup+at+query+time&amp;url=https%3A%2F%2Fblog.algolia.com%2Finside-the-engine-part-7-better-relevance-via-dedup-at-query-time%2F&amp;via=algolia" title="Share to Twitter" onclick="window.open(this.href,'targetWindow','toolbars=0,location=0,status=0,menubar=0,scrollbars=1,resizable=1,width=640,height=320,left=200,top=200');return false;"><i class="cs c-icon-cresta-twitter"></i></a></div><div class="sbutton  linkedin-cresta-share float" id="linkedin-cresta"><a rel="nofollow" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3A%2F%2Fblog.algolia.com%2Finside-the-engine-part-7-better-relevance-via-dedup-at-query-time%2F&amp;title=Inside+the+engine+part+7+%E2%80%93+Better+relevance+via+dedup+at+query+time&amp;source=https://blog.algolia.com/" title="Share to LinkedIn" onclick="window.open(this.href,'targetWindow','toolbars=0,location=0,status=0,menubar=0,scrollbars=1,resizable=1,width=640,height=320,left=200,top=200');return false;"><i class="cs c-icon-cresta-linkedin"></i></a></div><div style="clear: both;"></div></div>

<!--www.crestaproject.com Social Button Floating End-->
<link rel='stylesheet' id='hljstheme-css'  href='https://blog.algolia.com/wp-content/plugins/wp-code-highlightjs/styles/monokai-sublime.css' type='text/css' media='all' />
<script type='text/javascript' src='https://blog.algolia.com/wp-content/plugins/cresta-social-share-counter/js/jquery.cresta-social-effect.js'></script>
<script type='text/javascript' src='https://s0.wp.com/wp-content/js/devicepx-jetpack.js'></script>
<script type='text/javascript' src='https://blog.algolia.com/wp-includes/js/comment-reply.min.js'></script>
<script type='text/javascript' src='https://blog.algolia.com/wp-content/themes/algolia/library/js/scripts.js'></script>
<script type='text/javascript' src='https://blog.algolia.com/wp-includes/js/wp-embed.min.js'></script>
<script type='text/javascript' src='https://blog.algolia.com/wp-content/plugins/wp-code-highlightjs/highlight.common.pack.js'></script>
<script type='text/javascript' src='https://blog.algolia.com/wp-content/plugins/wp-code-highlightjs/highlight.custom.pack.js'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var embedVars = {"disqusConfig":{"platform":"wordpress@4.7.5","language":""},"disqusIdentifier":"5868 https:\/\/blog.algolia.com\/?p=5868","disqusShortname":"algoliablog","disqusTitle":"Inside the engine part 7 \u2013 Better relevance via dedup at query time","disqusUrl":"https:\/\/blog.algolia.com\/inside-the-engine-part-7-better-relevance-via-dedup-at-query-time\/","options":{"manualSync":false},"postId":"5868"};
/* ]]> */
</script>
<script type='text/javascript' src='https://blog.algolia.com/wp-content/plugins/disqus-comment-system/media/js/disqus.js'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var countVars = {"disqusShortname":"algoliablog"};
/* ]]> */
</script>
<script type='text/javascript' src='https://blog.algolia.com/wp-content/plugins/disqus-comment-system/media/js/count.js'></script>
    <style>pre.hljs {padding: 5px;}
pre.hljs code {}
pre code.hljs { background: none; } </style>
    <script type="text/javascript">
    (function($, window) {
        var init_fn_flag = false;
        var init_fn = (function() {
            if (init_fn_flag)
                return;
            init_fn_flag = true;
             hljs.configure({"tabReplace":"    "});
            $('pre code').each(function(i, block) {
                hljs.highlightBlock(block);
            });
        });
        $(document).ready(init_fn);
        $(window).on("load", init_fn);
    })(jQuery, window);
    </script>
<script type='text/javascript' src='https://stats.wp.com/e-201721.js' async defer></script>
<script type='text/javascript'>
	_stq = window._stq || [];
	_stq.push([ 'view', {v:'ext',j:'1:4.7.1',blog:'116008343',post:'5868',tz:'-7',srv:'blog.algolia.com'} ]);
	_stq.push([ 'clickTrackerInit', '116008343', '5868' ]);
</script>

	</body>

</html> <!-- end of site. what a ride! -->
